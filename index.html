<!--
Para limpiar la PWA en Android:
1. Ajustes Android → Apps → Chrome → Storage → Site Storage → GastoGo → Borrar datos.
2. O en Chrome: chrome://settings/siteData, busca tu dominio, elimina datos.
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GastoGo...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    header { background:#4CAF50; color:#fff; padding:1rem; text-align:center; }
    main { padding:1rem; }
    section { margin-top:1.5rem; border:1px solid #ddd; padding:1rem; border-radius:8px; }
    h2 { margin-top:0; }
    .flex { display:flex; align-items:center; }
    .flex > * { margin-right:8px; }
    .input-group { display:flex; align-items:center; }
    .input-group span { margin-right:8px; color:#666; pointer-events:none; }
    .error-msg { font-size:0.8rem; color:red; margin-top:-0.5rem; margin-bottom:0.5rem; }
    input.invalid { border-color:red; }
    input, select, textarea, button { display:block; width:100%; margin:0.5rem 0; padding:0.5rem; box-sizing:border-box; }
    .gasto-item, .hist-item { border-bottom:1px solid #ddd; padding:0.5rem 0; }
    .saldo { font-size:1.2rem; font-weight:bold; }
  </style>
</head>
<body>
  <header><h1>GastoGo...</h1></header>
  <main>
    <!-- Ingresos -->
    <section id="secIngresos">
      <h2>Definir Ingresos</h2>
      <div class="input-group">
        <span>$</span>
        <input type="text" id="inputIngresos" maxlength="13" placeholder="0,00"/>
      </div>
  
      <small style="display:block; font-size:0.85rem; color:#666; margin-top:-0.5rem; margin-bottom:0.5rem;">
       Ingresa tu salario o ingresos mensuales
      </small>

      <div id="errorIngresos" class="error-msg"></div>
      <button type="button" id="btnSetIngresos">Guardar</button>
      <div class="input-group">
        <span>$</span>
        <input type="text" id="inputOtrosIngresos" maxlength="13" placeholder="0,00" />
      </div>

      <small style="display:block; font-size:0.85rem; color:#666; margin-top:-0.5rem; margin-bottom:0.5rem;">
       Ingresa tus ingresos extras
      </small>
      
      <div id="errorOtros" class="error-msg"></div>
      <button type="button" id="btnAddOtrosIngresos">Agregar Otros</button>
      <div class="saldo">Saldo restante: <span id="saldoRestante">$0,00</span></div>
      <button type="button" id="btnFinalizarMes">Finalizar Mes</button>
    </section>

    <!-- Registrar Gasto -->
    <section id="secGastos">
      <h2>Registrar gasto</h2>
      <input type="date" id="fecha" />
      <div class="input-group">
        <span>$</span>
        <input type="text" id="monto" maxlength="13" placeholder="0,00" />
      </div>
      <div class="flex">
        <select id="categoria">
          <option disabled selected value="">-- Seleccionar categoría --</option>
        </select>
        <button type="button" id="btnAddCat">+</button>
        <button type="button" id="btnDelCat">–</button>
      </div>
      <input type="text" id="subcat" placeholder="Subcategoría" />
      <textarea id="obs" placeholder="Observaciones"></textarea>
      <button type="button" id="btnGuardar">Guardar Gasto</button>
    </section>

    <!-- Historial de Gastos -->
    <section id="secHistorial">
      <h2>Historial de Gastos</h2>
      <div id="listaGastos"></div>
    </section>

    <!-- Historial de Meses -->
    <section id="secHistorialMeses">
      <h2>Historial de Meses Finalizados</h2>
      <div id="listaMeses"></div>
    </section>
  </main>

  <script>
  (function() {
    // Claves y datos
    var selCat = document.getElementById('categoria');
    var keyG='gastos', keyC='categorias', keyI='ingresos', keyO='otrosIngresos', keyH='historialMeses', keyM='moneda';
    var gastos, ingresos, otrosIngresos, historial, categorias, moneda;
    // Elementos
    var inpI, btnI, errI, inpO, btnO, errO, saldoEl, btnFin;
    var fechaInput, montoInput, selCat, btnAddCat, btnDelCat, subcatInput, obsInput, btnGuardar;

    function loadData() {
      gastos = JSON.parse(localStorage.getItem(keyG)||'[]');
      ingresos = parseFloat(localStorage.getItem(keyI))||0;
      otrosIngresos = JSON.parse(localStorage.getItem(keyO)||'[]');
      historial = JSON.parse(localStorage.getItem(keyH)||'[]');
      moneda = localStorage.getItem(keyM)||'$';
      categorias = JSON.parse(localStorage.getItem(keyC)||'null');
      if(!Array.isArray(categorias)||categorias.length===0){
        categorias=['Vivienda','Impuestos y servicios','Vehículo','Otros gastos'];
        localStorage.setItem(keyC,JSON.stringify(categorias));
      }
    }

function formatRL(str) {
  var digits = str.replace(/\D/g,'');
  digits = digits.slice(-10);
  while (digits.length < 3) digits = '0' + digits;
  // separa parte entera y decimales
  var intPart = digits.slice(0, -2);
  var decPart = digits.slice(-2);
  // elimina ceros iniciales, pero deja al menos un cero
  intPart = intPart.replace(/^0+(?=\d)/, '');
  // añade separadores de miles
  intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  return intPart + ',' + decPart;
}


    function fmt(v){return parseFloat(v).toFixed(2);}    
    function validNum(str){return /^\d+(\,\d{1,2})?$/.test(str);}    

    function refreshCategories(){
      selCat.innerHTML='<option disabled selected value="">-- Seleccionar categoría --</option>'+
        categorias.map(function(c){return '<option>'+c+'</option>';}).join('');
    }
    function refreshGastos(){
      var html=gastos.map(function(g){return '<div class="gasto-item">'+g.fecha+' – '+g.categoria+'/'+g.subcat+': '+moneda+g.monto+'</div>';}).join('')||'<em>No hay gastos</em>';
      document.getElementById('listaGastos').innerHTML=html;
    }
    function refreshMeses(){
      var html=historial.map(function(m,i){
        var tg=m.gastos.reduce(function(s,g){return s+parseFloat(g.monto);},0);
        var to=m.otrosIngresos.reduce(function(s,o){return s+parseFloat(o);},0);
        var sal=(m.ingresos+to-tg).toFixed(2);
        return '<div class="hist-item"><strong>'+new Date(m.fecha).toLocaleDateString()+'</strong><br>'+
          'Ingresos: '+moneda+parseFloat(m.ingresos).toFixed(2)+' + Otros: '+moneda+to.toFixed(2)+'<br>'+
          'Gastos: '+moneda+tg.toFixed(2)+' | Saldo: '+moneda+sal+
          ' <button onclick="borrarMes('+i+')">Eliminar</button></div>';
      }).join('')||'<em>No hay meses finalizados</em>';
      document.getElementById('listaMeses').innerHTML=html;
    }
    
function refreshSaldo() {
  // 1) Sumar gastos y otrosIngresos tal como estaban
  var totalGastos = gastos.reduce(function(s, g){
    return s + (parseFloat(g.monto) || 0);
  }, 0);
  var totalOtros = otrosIngresos.reduce(function(s, o){
    return s + (parseFloat(o) || 0);
  }, 0);
  var ingresoBase = parseFloat(ingresos) || 0;

  // 2) Cálculo puro de unidades
  var restante = ingresoBase + totalOtros - totalGastos;

  // 3) Convertir a centavos (entero)
  var cents = Math.round(restante * 100).toString();

  // 4) Formatear con formatRL (que interpreta la string de centavos)
  var formatted = formatRL(cents);

  // 5) Mostrar con el símbolo de moneda
  saldoEl.textContent = moneda + formatted;
}



    function init(){
      // Referencias DOM
      inpI=document.getElementById('inputIngresos'); btnI=document.getElementById('btnSetIngresos'); errI=document.getElementById('errorIngresos');
      inpO=document.getElementById('inputOtrosIngresos'); btnO=document.getElementById('btnAddOtrosIngresos'); errO=document.getElementById('errorOtros');
      saldoEl=document.getElementById('saldoRestante'); btnFin=document.getElementById('btnFinalizarMes');
      btnAddCat=document.getElementById('btnAddCat'); btnDelCat=document.getElementById('btnDelCat');
      subcatInput=document.getElementById('subcat'); obsInput=document.getElementById('obs'); 
    
      const fechaInput   = document.getElementById('fecha');
      const montoInput   = document.getElementById('monto');
      const btnGuardar   = document.getElementById('btnGuardar');

      
      loadData();
      // Fijar fecha al día de hoy
      fechaInput.value = new Date().toISOString().slice(0,10);

      // Inicial UI
      inpI.value=formatRL(''); inpO.value=formatRL(''); montoInput.value=formatRL('');
      inpI.disabled=false; btnI.disabled=false; errI.textContent=''; errO.textContent='';
      refreshCategories(); refreshGastos(); refreshMeses(); refreshSaldo();

      // Formateo dinámico derecha→izquierda
      [inpI, inpO, montoInput].forEach(function(el){
        el.addEventListener('input', function(e) {
          e.target.value = formatRL(e.target.value);
        });
      });

// --- Guardar Ingresos sin validar formato, solo vacío ---
btnI.onclick = function(){
  var v = inpI.value.trim();
  // 1) Validar no vacío y no 0
  var rawTest = v.replace(/\./g,'').replace(',','.');
  var nTest = parseFloat(rawTest) || 0;
  if (!v || nTest <= 0) {
    errI.textContent = 'Debes cargar un valor';
    inpI.classList.add('invalid');
    return;
  }
  // 2) Limpiar error
  errI.textContent = '';
  inpI.classList.remove('invalid');
  // 3) Confirmación
  if (!confirm('¿Desea guardar el monto ingresado?')) return;

  // 4) Guardar ingreso
  ingresos = nTest;
  localStorage.setItem(keyI, ingresos);

  // 5) Reiniciar gastos y otros
  gastos = [];
  otrosIngresos = [];
  localStorage.setItem(keyG, JSON.stringify(gastos));
  localStorage.setItem(keyO, JSON.stringify(otrosIngresos));

  // 6) Actualizar UI
  inpI.disabled = true;
  btnI.disabled = true;
  refreshGastos();
  refreshMeses();
  refreshSaldo();
};


// --- Agregar Otros ingresos sin validar formato, solo vacío ---
btnO.onclick = function(){
  var v = inpO.value.trim();
  // 1) Validar no vacío y no 0
  var rawTest = v.replace(/\./g,'').replace(',','.');
  var nTest = parseFloat(rawTest) || 0;
  if (!v || nTest <= 0) {
    errO.textContent = 'Debes cargar un valor';
    inpO.classList.add('invalid');
    return;
  }
  // 2) Limpiar error
  errO.textContent = '';
  inpO.classList.remove('invalid');
  // 3) Confirmación
  if (!confirm('¿Desea agregar este monto a Otros Ingresos?')) return;

  // 4) Guardar otros ingresos
  otrosIngresos.push(nTest);
  localStorage.setItem(keyO, JSON.stringify(otrosIngresos));

  // 5) UI
  inpO.value = formatRL('');
  refreshSaldo();
};




btnGuardar.onclick = function() {
  // 1) Convertir el valor formateado (e.g. "1.234,56") a número puro 1234.56
  var raw = montoInput.value
    .replace(/\./g, '')   // elimina puntos de miles
    .replace(',', '.');   // convierte coma decimal a punto
  var montoNum = parseFloat(raw) || 0;

  // 2) Crear el objeto gasto guardando un número (no string)
  var g = {
    fecha:     fechaInput.value,
    monto:     montoNum,    // guardamos el número puro
    categoria: selCat.value,
    subcat:    subcatInput.value,
    obs:       obsInput.value
  };

  // 3) Almacenar y refrescar UI
  gastos.unshift(g);
  localStorage.setItem(keyG, JSON.stringify(gastos));
  refreshGastos();
  refreshSaldo();

  // 4) Limpiar campos y deshabilitar botón
  montoInput.value      = formatRL('');  
  subcatInput.value     = '';
  obsInput.value        = '';
  btnGuardar.disabled   = true;
};


      // Categorías
      btnAddCat.onclick=function(){var n=prompt('Nueva categoría:')||'';n=n.trim();if(n&&categorias.indexOf(n)===-1){categorias.push(n);localStorage.setItem(keyC,JSON.stringify(categorias));refreshCategories();selCat.value=n;}};
      btnDelCat.onclick=function(){var c=selCat.value;if(c&&confirm('Eliminar '+c+'?')){categorias=categorias.filter(function(i){return i!==c;});localStorage.setItem(keyC,JSON.stringify(categorias));refreshCategories();}};

      // Finalizar Mes
btnFin.onclick = function() {
  // 1) Confirmación
  if (!confirm('¿Estás seguro que deseas finalizar el mes?')) {
    return; // Cancela la acción si el usuario elige NO
  }

  // 2) Lógica de guardado en historial de meses
  historial.unshift({
    ingresos: ingresos,
    otrosIngresos: otrosIngresos,
    gastos: gastos,
    fecha: new Date().toISOString()
  });
  localStorage.setItem(keyH, JSON.stringify(historial));

  // 3) Reinicio de datos
  gastos = [];
  ingresos = 0;
  otrosIngresos = [];
  localStorage.setItem(keyG, JSON.stringify(gastos));
  localStorage.setItem(keyI, ingresos);
  localStorage.setItem(keyO, JSON.stringify(otrosIngresos));

  // 4) Actualizar UI
  inpI.disabled   = false;
  btnI.disabled   = false;
  inpI.value      = formatRL('');
  errI.textContent= '';
  inpO.value      = formatRL('');
  refreshGastos();
  refreshMeses();
  refreshSaldo();
};

      // Borrar Mes
      window.borrarMes=function(i){historial.splice(i,1);localStorage.setItem(keyH,JSON.stringify(historial));refreshMeses();};
    }
    if(document.readyState==='complete')init();else document.addEventListener('DOMContentLoaded',init);
    if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js');}
  })();
  </script>
</body>
</html>
