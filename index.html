<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GastoGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    header { background:#4CAF50; color:#fff; padding:1rem; text-align:center; }
    main { padding:1rem; }
    section { margin-top:1.5rem; border:1px solid #ddd; padding:1rem; border-radius:8px; }
    h2 { margin-top:0; }
    input, select, textarea, button { display:block; width:100%; margin:0.5rem 0; padding:0.5rem; box-sizing:border-box; }
    .gasto-item { border-bottom:1px solid #ddd; padding:0.5rem 0; }
    .flex { display:flex; justify-content: space-between; align-items: center; }
    .saldo { font-size:1.2rem; font-weight:bold; }
    .hist-item { border-bottom:1px solid #ccc; padding:0.5rem 0; }
  </style>
</head>
<body>
  <header><h1>GastoGo</h1></header>
  <main>
    <!-- Selección de moneda -->
    <section id="secMoneda">
      <h2>Elige tu moneda</h2>
      <select id="selMoneda">
        <option value="$">$ Pesos</option>
        <option value="USD">USD</option>
      </select>
    </section>

<!-- Ingresos -->
<section id="secIngresos">
  <h2>Definir Ingresos Mensuales</h2>
  <div class="flex">
    <input type="number" id="inputIngresos" placeholder="Monto de ingresos" />
    <button id="btnSetIngresos">Guardar</button>
  </div>
  <div class="flex">
    <input type="number" id="inputOtrosIngresos" placeholder="Otros ingresos" />
    <button id="btnAddOtrosIngresos">Agregar Otros Ingresos</button>
  </div>
  <div class="saldo">Saldo restante: <span id="saldoRestante"></span></div>
  <button id="btnFinalizarMes">Finalizar Mes</button>
</section>


    <!-- Registrar Gasto -->
    <section id="secGastos">
      <h2>Registrar Gasto</h2>
      <input type="date" id="fecha" />
      <input type="number" id="monto" placeholder="Monto" />
      <select id="categoria"></select>
      <input type="text" id="subcat" placeholder="Subcategoría" />
      <textarea id="obs" placeholder="Observaciones"></textarea>
      <button id="btnGuardar">Guardar Gasto</button>
    </section>

    <!-- Historial de Gastos -->
    <section id="secHistorial">
      <h2>Historial de Gastos</h2>
      <div id="listaGastos"></div>
    </section>

    <!-- Historial de Meses -->
    <section id="secHistorialMeses">
      <h2>Historial de Meses Finalizados</h2>
      <div id="listaMeses"></div>
    </section>
  </main>

  <script>
    // Claves
    const keyG = 'gastos', keyC = 'categorias', keyI = 'ingresos', keyH = 'historialMeses', keyM = 'moneda';

    // Carga inicial
    let gastos = JSON.parse(localStorage.getItem(keyG) || '[]');
    let categorias = JSON.parse(localStorage.getItem(keyC) || '["General"]');
    let ingresos = parseFloat(localStorage.getItem(keyI) || '0');
    let otrosIngresos = JSON.parse(localStorage.getItem('otrosIngresos') || '[]');
    let historial = JSON.parse(localStorage.getItem(keyH) || '[]');
    let moneda = localStorage.getItem(keyM) || '$';

    // Elementos
    const selMon = document.getElementById('selMoneda');
    const selCat = document.getElementById('categoria');
    const saldoEl = document.getElementById('saldoRestante');
    const inpIng = document.getElementById('inputIngresos');

    // Renders
    function refreshMoneda(){
      selMon.value = moneda;
    }
    function refreshCats(){
      selCat.innerHTML = categorias.map(c=>`<option>${c}</option>`).join('');
    }
    function refreshList(){
      document.getElementById('listaGastos').innerHTML =
        gastos.map((g,i)=>`
          <div class="gasto-item">
            ${g.fecha} – ${g.categoria}/${g.subcat}: ${moneda}${parseFloat(g.monto).toFixed(2)}
          </div>
        `).join('') || '<em>No hay gastos</em>';
    }
    function refreshSaldo(){
  const totalGastado = gastos.reduce((s,g)=>s + parseFloat(g.monto),0);
  const totalOtros   = otrosIngresos.reduce((s,o)=>s + parseFloat(o),0);
  const restante     = (ingresos + totalOtros - totalGastado).toFixed(2);
  document.getElementById('saldoRestante').textContent = `${moneda}${restante}`;
}

    function refreshMeses(){
      document.getElementById('listaMeses').innerHTML =
        historial.map((m,i)=> {
          const gastado = m.gastos.reduce((s,g)=>s + parseFloat(g.monto),0);
          const saldo = (m.ingresos - gastado).toFixed(2);
          return `
          <div class="hist-item">
            <strong>${new Date(m.fecha).toLocaleDateString()}</strong><br>
            Ingresos: ${moneda}${m.ingresos.toFixed(2)} | Gastos: ${moneda}${gastado.toFixed(2)} | Saldo: ${moneda}${saldo}
            <button onclick="borrarMes(${i})">Eliminar</button>
          </div>`;
        }).join('') || '<em>No hay meses finalizados</em>';
    }
    // Inicializa UI
    refreshMoneda(); refreshCats(); refreshList(); refreshSaldo(); refreshMeses();

    // Eventos
    selMon.onchange = ()=>{
      moneda = selMon.value;
      localStorage.setItem(keyM, moneda);
      refreshList(); refreshSaldo(); refreshMeses();
    };
// Guardar ingresos iniciales y bloquear edición
document.getElementById('btnSetIngresos').onclick = () => {
  ingresos = parseFloat(inpIng.value) || 0;
  localStorage.setItem('ingresos', ingresos);
  inpIng.disabled = true;
  document.getElementById('btnSetIngresos').disabled = true;
  refreshSaldo();
};

// Agregar “Otros Ingresos”
document.getElementById('btnAddOtrosIngresos').onclick = () => {
  const o = parseFloat(document.getElementById('inputOtrosIngresos').value) || 0;
  otrosIngresos.push(o);
  localStorage.setItem('otrosIngresos', JSON.stringify(otrosIngresos));
  document.getElementById('inputOtrosIngresos').value = '';
  refreshSaldo();
};

      // mantiene fecha del input
    };
    document.getElementById('btnGuardar').onclick = ()=>{
      const g = {
        fecha: document.getElementById('fecha').value,
        monto: document.getElementById('monto').value,
        categoria: selCat.value,
        subcat: document.getElementById('subcat').value,
        obs: document.getElementById('obs').value
      };
      gastos.unshift(g);
      localStorage.setItem(keyG, JSON.stringify(gastos));
      refreshList(); refreshSaldo();
      // limpia solo campos de texto
      document.getElementById('monto').value = '';
      document.getElementById('subcat').value = '';
      document.getElementById('obs').value = '';
    };
document.getElementById('btnFinalizarMes').onclick = () => {
  historial.unshift({ ingresos, otrosIngresos, gastos, fecha: new Date().toISOString() });
  localStorage.setItem('historialMeses', JSON.stringify(historial));
  // Reset mensual
  gastos = []; ingresos = 0; otrosIngresos = [];
  localStorage.removeItem('gastos');
  localStorage.removeItem('ingresos');
  localStorage.removeItem('otrosIngresos');
  inpIng.value = ''; inpIng.disabled = false;
  document.getElementById('btnSetIngresos').disabled = false;
  refreshGastos();
  refreshMeses();
  refreshSaldo();
  alert('Mes finalizado y guardado en historial.');
};

    function borrarMes(idx){
      if(!confirm('Eliminar mes de historial?')) return;
      historial.splice(idx,1);
      localStorage.setItem(keyH, JSON.stringify(historial));
      refreshMeses();
    }
  </script>
</body>
</html>
